// Generated by CoffeeScript 1.6.2
(function() {
  var Editor, debounce, urlVars,
    _this = this,
    __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  View.prototype._postCreate = function() {
    return _this.style.backgroundColor = "rgba(255,0,0,0.5)";
  };

  View.prototype.__insertElement = function() {
    return $("#canvas").append(this._element);
  };

  urlVars = function() {
    var data, pair, vars, _i, _len, _ref;

    vars = {};
    if (window.location.href.indexOf("#") !== -1) {
      data = window.location.href.split("#")[1];
    } else {
      data = window.location.search.replace("?", "");
    }
    if (data.slice(-1) === "/") {
      data = data.slice(0, +(data.length - 2) + 1 || 9e9);
    }
    _ref = data.split("&");
    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
      pair = _ref[_i];
      pair = pair.split("=");
      vars[pair[0]] = pair[1].replace(/\/$/, "");
    }
    console.log(vars);
    return vars;
  };

  debounce = function(threshold, func, execAsap) {
    var debounced, timeout;

    timeout = false;
    return debounced = function() {
      var args, delayed, obj;

      obj = this;
      args = arguments;
      delayed = function() {
        if (!execAsap) {
          func.apply(obj, args);
        }
        return timeout = null;
      };
      if (timeout) {
        clearTimeout(timeout);
      } else if (execAsap) {
        func.apply(obj, args);
      }
      return timeout = utils.delay(threshold || 100, delayed);
    };
  };

  Editor = (function() {
    var LocalSaveKey;

    LocalSaveKey = "framer.editor.code:" + window.location.href;

    console.log("LocalSaveKey", LocalSaveKey);

    function Editor() {
      this._run = __bind(this._run, this);
      this._clearTimers = __bind(this._clearTimers, this);
      this._onChange = __bind(this._onChange, this);
      this.loadFile = __bind(this.loadFile, this);
      this.setCode = __bind(this.setCode, this);      this._editCount = 0;
      this._savePoint = 0;
      this._editor = ace.edit("editor");
      this._editor.session.setMode("ace/mode/javascript");
      this._editor.setTheme("ace/theme/twilight");
      this._editor.getSession().on("change", this._onChange);
    }

    Editor.prototype.run = debounce(100, function() {
      return this._run();
    });

    Editor.prototype.setCode = function(code) {
      if (!code) {
        return;
      }
      this._editor.setValue(code);
      this._editor.session.selection.clearSelection();
      this._editor.moveCursorTo(0, 0);
      return this._updateChangeCount();
    };

    Editor.prototype.getCode = function() {
      return this._editor.getValue();
    };

    Editor.prototype.saveLocal = function() {
      console.log("saveLocal");
      localStorage.setItem(this.LocalSaveKey, this.getCode());
      return this._savePoint = this._editCount;
    };

    Editor.prototype.loadLocal = function() {
      console.log("loadLocal");
      this.setCode(localStorage.getItem(this.LocalSaveKey));
      return this.run();
    };

    Editor.prototype.fileUrl = function() {
      return urlVars().path;
    };

    Editor.prototype.exampleUrl = function() {
      return urlVars().example;
    };

    Editor.prototype.loadExample = function(path, callback) {
      var cssNode, path1, path2, path3, path4,
        _this = this;

      path = "GoogleNow";
      path1 = "/static/examples/" + path + "/framer/views." + path + ".js";
      path2 = "/static/examples/" + path + "/framer/framer.js";
      path3 = "/static/examples/" + path + "/framer/framerps.js";
      path4 = "/static/examples/" + path + "/app.js";
      cssNode = $("<link/>", {
        rel: "stylesheet",
        type: "text/css",
        href: "/static/examples/" + path + "/style.css"
      }).appendTo("head");
      return $.getScript(path1, function() {
        return $.getScript(path2, function() {
          Framer.config.baseUrl = "/static/examples/" + path + "/";
          View.prototype.__insertElement = function() {
            return $("#canvas").append(this._element);
          };
          return $.get(path3, function(data) {
            _this._prependEval = data;
            return _this.loadFile(path4, callback);
          });
        });
      });
    };

    Editor.prototype.gistId = function() {
      return urlVars().gist;
    };

    Editor.prototype.loadFile = function(path) {
      var done, promise,
        _this = this;

      promise = $.get(path);
      done = function(data) {
        _this.setCode(data);
        return _this._editCount = 0;
      };
      promise.fail(function(xhr) {
        if (xhr.responseText) {
          return done(xhr.responseText);
        } else {
          return console.log("loadFile error", xhr);
        }
      });
      return promise.done(function(data) {
        return done(data);
      });
    };

    Editor.prototype.loadGist = function() {};

    Editor.prototype.saveGist = function() {
      return $.get(path, function(data) {
        editor.setValue(data);
        editor.session.selection.clearSelection();
        return editor.moveCursorTo(0, 0);
      });
    };

    Editor.prototype.hasEdits = function() {
      return window.location.href.indexOf("#edited") !== -1;
    };

    Editor.prototype._updateChangeCount = function() {
      return this._editCount += 1;
    };

    Editor.prototype._onChange = function() {
      this._updateChangeCount();
      this._track("Editor", "Edit");
      return this.run();
    };

    Editor.prototype._clearTimers = function() {
      var timer, _i, _len, _ref, _results;

      if (window._delayTimers) {
        _ref = window._delayTimers;
        _results = [];
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          timer = _ref[_i];
          _results.push(clearTimeout(timer));
        }
        return _results;
      }
    };

    Editor.prototype._track = debounce(500, function(module, type, data) {
      if (this._editCount < 6) {
        return;
      }
      return _gaq.push(["_trackEvent", module, type, data]);
    });

    Editor.prototype._run = function() {
      var code;

      this._clearTimers();
      code = this.getCode();
      if (!code) {
        return;
      }
      $("#canvas").html("");
      if (this._prependEval) {
        eval(this._prependEval);
      }
      eval(code);
      if (this._editCount > 0) {
        if (!this.hasEdits()) {
          history.pushState({}, "", window.location + "#edited");
        }
      }
      return this.saveLocal();
    };

    return Editor;

  })();

  $(document).ready(function() {
    window.editor = new Editor();
    if (editor.exampleUrl()) {
      return editor.loadExample(editor.exampleUrl(), function() {
        if (editor.hasEdits()) {
          return editor.loadLocal();
        }
      });
    } else if (editor.hasEdits()) {
      return editor.loadLocal();
    } else if (editor.fileUrl()) {
      return editor.loadFile(editor.fileUrl());
    }
  });

}).call(this);
